<!DOCTYPE html>
<html>
<head>
  <title>AutoThinker Tableau WDC</title>
  <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, button { margin: 6px 0; padding: 8px; }
    .btn { cursor: pointer; border: none; border-radius: 6px; }
    .primary { background: #007bff; color: white; }
    .secondary { background: #6c757d; color: white; }
    .section { margin-top: 20px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9; }
    h3 { margin-bottom: 8px; }
    pre { background: #f4f4f4; padding: 10px; border-radius: 6px; white-space: pre-wrap; }
    iframe { width: 100%; height: 400px; border: none; border-radius: 6px; margin-top: 8px; }
  </style>
</head>
<body>
  <h1>ðŸš€ AutoThinker Tableau WDC</h1>
  <p>Enter a business idea and preview integrated insights:</p>

  <input type="text" id="ideaInput" placeholder="Enter your business idea" style="width:300px;">
  <br>
  <button class="btn primary" id="getDataBtn">ðŸ“Š Get Data (Tableau)</button>
  <button class="btn secondary" id="simulateBtn">ðŸ§ª Run in Simulator</button>

  <div id="resultsContainer">
    <div class="section">
      <h3>âœ¨ AI Insights</h3>
      <pre id="aiResults">No data yet...</pre>
    </div>

    <div class="section">
      <h3>ðŸ“‡ Salesforce CRM Insights</h3>
      <pre id="sfResults">No data yet...</pre>
    </div>

    <div class="section">
      <h3>ðŸ“Š Tableau Visual Insights</h3>
      <pre id="tableauResults">No data yet...</pre>
      <div id="tableauEmbed"></div>
    </div>
  </div>

  <script>
    const SERVER_URL = window.location.origin;

    function renderTableauResult(data) {
      const embedDiv = document.getElementById("tableauEmbed");
      embedDiv.innerHTML = "";
      document.getElementById("tableauResults").innerText = JSON.stringify(data, null, 2);

      if (data.embedUrl) {
        const iframe = document.createElement("iframe");
        iframe.src = data.embedUrl;
        embedDiv.appendChild(iframe);
      }
    }

    // Step 1: Define WDC schema
    const myConnector = tableau.makeConnector();

    myConnector.getSchema = function(schemaCallback) {
      const cols = [
        { id: "text", dataType: tableau.dataTypeEnum.string },
        { id: "source", dataType: tableau.dataTypeEnum.string },
        { id: "confidence", dataType: tableau.dataTypeEnum.int },
        { id: "risk", dataType: tableau.dataTypeEnum.string },
        { id: "opportunityScore", dataType: tableau.dataTypeEnum.int },
        { id: "opportunityType", dataType: tableau.dataTypeEnum.string }
      ];
      schemaCallback([{ id: "autothinkerInsights", alias: "AutoThinker AI Insights", columns: cols }]);
    };

    myConnector.getData = async function(table, doneCallback) {
      const idea = document.getElementById("ideaInput").value || "Default Idea";

      try {
        // Fetch AI
        const aiResp = await fetch(`${SERVER_URL}/api/ai/generate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ idea })
        });
        const aiJson = await aiResp.json();
        document.getElementById("aiResults").innerText = JSON.stringify(aiJson, null, 2);

        // Fetch Salesforce
        const sfResp = await fetch(`${SERVER_URL}/api/salesforce/data?idea=${encodeURIComponent(idea)}`);
        const sfJson = await sfResp.json();
        document.getElementById("sfResults").innerText = JSON.stringify(sfJson, null, 2);

        // Fetch Tableau
        const tbResp = await fetch(`${SERVER_URL}/api/tableau/embed/sampleDashboard`);
        const tbJson = await tbResp.json();
        renderTableauResult(tbJson);

        // âœ… Feed Tableau with AI rows
        const rows = (aiJson.insights || []).map(item => ({
          text: item.text,
          source: item.source,
          confidence: item.confidence || 0,
          risk: item.risk || "Unknown",
          opportunityScore: item.opportunityScore || 0,
          opportunityType: item.opportunityType || "N/A"
        }));

        table.appendRows(rows);
        doneCallback();
      } catch (err) {
        document.getElementById("aiResults").innerText = "Error: " + err.message;
        doneCallback();
      }
    };

    tableau.registerConnector(myConnector);

    // Step 2: Tableau button
    document.getElementById("getDataBtn").addEventListener("click", () => {
      tableau.connectionName = "AutoThinker Insights";
      tableau.submit();
    });

    // Step 3: Simulator button (show all APIs without Tableau)
    document.getElementById("simulateBtn").addEventListener("click", async () => {
      const idea = document.getElementById("ideaInput").value || "Simulator Idea";
      try {
        const aiResp = await fetch(`${SERVER_URL}/api/ai/generate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ idea })
        });
        const aiJson = await aiResp.json();
        document.getElementById("aiResults").innerText = JSON.stringify(aiJson, null, 2);

        const sfResp = await fetch(`${SERVER_URL}/api/salesforce/data?idea=${encodeURIComponent(idea)}`);
        const sfJson = await sfResp.json();
        document.getElementById("sfResults").innerText = JSON.stringify(sfJson, null, 2);

        const tbResp = await fetch(`${SERVER_URL}/api/tableau/embed/sampleDashboard`);
        const tbJson = await tbResp.json();
        renderTableauResult(tbJson);
      } catch (err) {
        document.getElementById("aiResults").innerText = "Simulator Error: " + err.message;
      }
    });
  </script>
</body>
</html>
